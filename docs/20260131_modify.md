# Invest プロジェクト改善タスク分解（チェックリスト）  
  
## 0. 事前整備（開発環境・運用の土台）  
- [ ] **Python 仮想環境（venv）前提に統一**  
  - [ ] `python/` 配下に `venv/` を作成する手順を決める（例: `python -m venv .venv`）  
  - [ ] `README.md` を追加し、セットアップ手順（Windows想定）を記載  
  - [ ] `.gitignore` に `.venv/`, `__pycache__/`, `python/cache/`, `python/output/` などを追加  
  - [ ] `requirements.txt` からインストールできることを確認（`pip install -r requirements.txt`）  
  - [ ] （任意）`requirements-dev.txt` を作り、開発用（lint/format/test）を分離  
  
- [ ] **パッケージ構造の健全化（sys.path hack を減らす）**  
  - [ ] `python/` を「パッケージとして実行」できる形に寄せる（例: `python -m invest.main` のような実行）  
  - [ ] `sys.path.insert(...)` を使っている箇所を棚卸し（`main.py`, `debug_stage2.py`, `backtest/engine.py`, `screening/screener.py`, `scripts/update_tickers_extended.py`）  
  - [ ] 可能な範囲で相対 import / パッケージ import に置き換え  
  
---  
  
## 1. `update_tickers_extended.py` のロジック可視化＆信頼性改善  
### 1-1. 何をどれだけ取れているかを必ず出す（ターミナル出力改善）  
- [ ] **取得ソース別の件数を表示**  
  - [ ] S&P500（Wikipedia）取得件数  
  - [ ] NASDAQ（nasdaqtrader）取得件数  
  - [ ] NYSE（nasdaqtrader otherlisted）取得件数  
  - [ ] Russell3000 proxy（IWV holdings）取得件数  
  - [ ] 重複除外後のユニーク総数  
- [ ] **フィルタ後の件数を段階的に表示**  
  - [ ] `info 取得成功数 / 失敗数`  
  - [ ] 条件（時価総額/価格/出来高/除外タイプ）ごとの除外数（カウント）  
  - [ ] 最終的に `max_tickers` で切る前/後の件数  
- [ ] **最終的な結果サマリを必ず表示**  
  - [ ] 「合計取得→ユニーク→info成功→フィルタ通過→保存件数」を1行サマリで表示  
  
### 1-2. Wikipedia 取得エラーの調査と改善  
- [ ] **現状のエラー内容を再現してログに出す**  
  - [ ] 例外メッセージを `logger.error` で出力（握り潰さない）  
  - [ ] `pd.read_html` が落ちる場合の原因（ネットワーク/HTML変更/SSL等）を切り分け  
- [ ] **フォールバック導入**  
  - [ ] Wikipedia が落ちた場合の代替ソース案を検討（例: GitHub上のS&P500リスト、別URL、キャッシュ）  
  - [ ] 「Wikipedia失敗→代替で継続→最終件数を出す」を実装  
  
### 1-3. 取得が170件しかない問題の原因調査  
- [ ] **原因調査（計測タスク）**  
  - [ ] ソース別取得数が何件か確認（S&P500が0ならWikipedia失敗濃厚）  
  - [ ] `get_ticker_info_batch` の成功率（成功が少ない＝レート制限/失敗多発）を確認  
  - [ ] フィルタで大量に落ちている条件（時価総額/価格/出来高/タイプ）を確認  
- [ ] **改善案を出す（必要なら複数）**  
  - [ ] yfinance `info` 取得の並列数・待ち時間・リトライ調整  
  - [ ] 途中結果の保存（バッチごとに中間保存）で失敗時の再開を可能にする  
  - [ ] 失敗銘柄リストをCSVに吐き出す（後で再試行できるように）  
  
---  
  
## 2. バックテスト中の「動いている感」を出す（CLI/ログUX改善）  
- [ ] **バックテスト進捗表示（スピナー or プログレスバー）**  
  - [ ] `trading_days` のループ進捗を表示（例: `tqdm`）  
  - [ ] 現在日付・保有数・総エクイティなど最低限のステータス表示  
  - [ ] 長時間処理でも「停止ではない」ことが分かる更新頻度に調整  
  
- [ ] **ログを見やすくする**  
  - [ ] `--verbose`（詳細ログ）と通常ログの切り替えを用意  
  - [ ] `entry/exit` が発生したときは必ず `INFO` で出す（今は `debug` が中心）  
  - [ ] バックテスト開始時に「benchmark有無」「対象銘柄数」「期間」「初期資金」を明示  
  
---  
  
## 3. 「なぜ Stage2 から漏れたか」を説明する機能（CLI）  
### 3-1. コマンド設計  
- [ ] `main.py` に新しい引数を追加（例）  
  - [ ] `--explain-stage2 TICKER`（単一銘柄の判定結果を説明）  
  - [ ] `--date YYYY-MM-DD`（任意：特定日で判定したい場合）  
  - [ ] `--no-benchmark` との組み合わせ可  
  
### 3-2. 出力内容（最低限）  
- [ ] Stage2 条件の **pass/fail を全項目表示**  
- [ ] 条件に使った **実数値** と **閾値** を併記（例: `close=xx, sma_50=yy`）  
- [ ] 52週高値/安値、距離%、出来高50MAなども表示  
- [ ] RS条件がある場合は RS系列の有効長（NaN除外後の本数）も表示  
  
### 3-3. 実装タスク  
- [ ] `StageDetector.check_stage2_conditions()` の結果をそのまま使って表示  
- [ ] データ取得失敗時・データ不足時のメッセージを明確化（例: 「252日未満」）  
- [ ] 出力フォーマットを固定（コピペしやすい）  
  
---  
  
## 4. 「バックテストで一度もエントリーしない」原因調査と改善  
### 4-1. まず事実確認の計測を入れる（調査ログ）  
- [ ] バックテスト中に以下をカウントして最後にサマリ表示  
  - [ ] `Stage2 判定を通過した回数（銘柄×日）`  
  - [ ] 条件ごとの失敗回数（どの条件がボトルネックか）  
  - [ ] 「資金不足で買えなかった」回数  
  - [ ] 「同時保有数上限で買えなかった」回数  
- [ ] 直近N日（例: 20日）だけでも「通過候補銘柄の一覧」をログ出力できるスイッチを用意（デバッグ用）  
  
### 4-2. よくあり得る原因の候補を潰す（改善タスク）  
- [ ] RS条件が厳しすぎる/NaNが多い問題を疑う  
  - [ ] RS系列の NaN 比率を計測して表示  
  - [ ] ベンチマーク不整合時は自動で no-benchmark に落とす（既に一部あり、バックテスト側の整合を再確認）  
- [ ] Stage2 条件の閾値が厳しすぎる可能性  
  - [ ] `min_price_above_52w_low` を緩める候補（例: 1.30→1.20 など）を提案できるようにする  
  - [ ] `sufficient_volume` の閾値を市場に合わせて調整できるよう確認  
- [ ] エントリー判定タイミングの問題  
  - [ ] 「Stage2になった日を検出したい」のか「常にStage2継続中のみ買う」のか要件を明確化  
  - [ ] 条件を満たした初回のみ買う/ブレイクアウト時のみ買う等、ルールを選択式にする（将来VCP復帰前提でもOK）  
  
### 4-3. 改善案の実装（段階的）  
- [ ] `--diagnose` モード（計測ログを出す）  
- [ ] パラメータ感度を確認するための「緩和プリセット」を追加（例: `--preset relaxed`）  
- [ ] エントリーが0件の場合に、原因サマリ（上位の失敗条件）を必ず表示  
  
